#!/usr/bin/env bash
set -x

export SOLC_FLAGS=--optimize

export ETH_FROM=$(seth coinbase)
export ETH_GAS=4200000

dapp build

export SETH_ASYNC=yes
GEMtx=$(dapp create DSToken 'ETH' 'ETH' 18)
SAItx=$(dapp create DSToken 'SAI' 'SAI' 18)
SINtx=$(dapp create DSToken 'SIN' 'SIN' 18)
SKRtx=$(dapp create DSToken 'SKR' 'SKR' 18)
POTtx=$(dapp create DSVault)
TAGtx=$(dapp create DSValue)

export SETH_ASYNC=no
GEM=$(seth receipt $GEMtx contractAddress)
SAI=$(seth receipt $SAItx contractAddress)
SIN=$(seth receipt $SINtx contractAddress)
SKR=$(seth receipt $SKRtx contractAddress)
POT=$(seth receipt $POTtx contractAddress)
TAG=$(seth receipt $TAGtx contractAddress)

SAI_TUB=$(dapp create Tub $GEM $SAI $SIN $SKR $POT $TAG)
export SAI_TUB=$SAI_TUB

export SETH_ASYNC=yes
seth send $SAI "setOwner(address)" $SAI_TUB
seth send $SIN "setOwner(address)" $SAI_TUB
seth send $SKR "setOwner(address)" $SAI_TUB
seth send $POT "setOwner(address)" $SAI_TUB

seth send $GEM "mint(uint128)" $(seth --to-uint256 $(seth --to-wei 100 ETH))

token approve $GEM $SAI_TUB $(seth --to-wei 100000 ETH)
token approve $SAI $SAI_TUB $(seth --to-wei 100000 ETH)
token approve $SKR $SAI_TUB $(seth --to-wei 100000 ETH)
token approve $SKR $POT $(seth --to-wei 100000 ETH)

seth send $TAG "poke(bytes32)" $(seth --to-uint256 $(seth --to-wei 1 ETH))
seth send $SAI_TUB "cork(uint128)" $(seth --to-uint256 $(seth --to-wei 100 ETH))

export SETH_ASYNC=no
LPS=$(dapp create DSToken 'LPS' 'LPS' 18)
LPC=$(dapp create SaiLPC $SAI $GEM $TAG $LPS $(seth --to-uint256 $(seth --to-wei 1.1 ETH)))
seth send $LPS "setOwner(address)" $LPC

MOM=$(dapp create SaiMom $SAI_TUB $LPC)

seth send $SAI_TUB "setAuthority(address)" $MOM
seth send $LPC "setAuthority(address)" $MOM
seth send $MOM "setRootUser(address,bool)" $ETH_FROM true

cat > load-env << EOF
#!/bin/bash

# sai deployment on $(seth chain) from $(git rev-parse HEAD)

export GEM=$GEM
export SAI=$SAI
export SIN=$SIN
export SKR=$SKR
export POT=$POT
export TAG=$TAG
export MOM=$MOM
export LPS=$LPS
export LPC=$LPC
export SAI_TUB=$SAI_TUB
EOF

echo SAI TUB DEPLOYED AT: $SAI_TUB
